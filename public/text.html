<!DOCTYPE html>
<html>
<head>
  <title>SMS Extraction Tester</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .container { max-width: 800px; margin: 0 auto; }
    textarea { width: 100%; height: 150px; margin: 10px 0; padding: 10px; }
    .result { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 5px; }
    .success { color: green; }
    .error { color: red; }
    .test-case { margin: 20px 0; padding: 10px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ SMS Reference Extraction Tester</h1>
    
    <div class="test-case">
      <h3>Test Single SMS</h3>
      <textarea id="smsInput" placeholder="Paste SMS here..."></textarea>
      <button onclick="testExtraction()">Test Extraction</button>
      <div id="result" class="result"></div>
    </div>

    <div class="test-case">
      <h3>Test Matching Pair</h3>
      <div>
        <h4>Sender SMS (User sent money):</h4>
        <textarea id="senderSMS" placeholder="Paste sender SMS..."></textarea>
      </div>
      <div>
        <h4>Receiver SMS (Admin received money):</h4>
        <textarea id="receiverSMS" placeholder="Paste receiver SMS..."></textarea>
      </div>
      <button onclick="testMatching()">Test Matching</button>
      <div id="matchResult" class="result"></div>
    </div>

    <div class="test-case">
      <h3>Quick Tests</h3>
      <button onclick="runQuickTests()">Run Quick Tests</button>
      <div id="quickTests" class="result"></div>
    </div>
  </div>

  <script>
    async function testExtraction() {
      const sms = document.getElementById('smsInput').value;
      const resultDiv = document.getElementById('result');
      
      if (!sms) {
        resultDiv.innerHTML = '<span class="error">Please enter SMS text</span>';
        return;
      }

      try {
        const response = await fetch('/api/test-sms-extraction', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sms })
        });
        
        const data = await response.json();
        
        if (data.success) {
          let html = `<h3 class="success">‚úÖ Extraction Successful</h3>`;
          html += `<p><strong>SMS Type:</strong> ${data.data.analysis.type} (${data.data.analysis.confidence})</p>`;
          html += `<p><strong>Reference:</strong> ${data.data.identifiers.refNumber || 'None'}</p>`;
          html += `<p><strong>Amount:</strong> ${data.data.amount}</p>`;
          html += `<p><strong>Payment Method:</strong> ${data.data.paymentMethod}</p>`;
          
          if (data.data.cleanedReference) {
            html += `<p><strong>Cleaned Reference:</strong> ${data.data.cleanedReference}</p>`;
          }
          
          html += `<h4>Pattern Matches:</h4><ul>`;
          Object.entries(data.data.patternMatches).forEach(([key, value]) => {
            html += `<li><strong>${key}:</strong> ${value.matched ? `‚úì ${value.value}` : '‚úó No match'}</li>`;
          });
          html += `</ul>`;
          
          resultDiv.innerHTML = html;
        } else {
          resultDiv.innerHTML = `<span class="error">${data.error}</span>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<span class="error">Error: ${error.message}</span>`;
      }
    }

    async function testMatching() {
      const sender = document.getElementById('senderSMS').value;
      const receiver = document.getElementById('receiverSMS').value;
      const resultDiv = document.getElementById('matchResult');
      
      if (!sender || !receiver) {
        resultDiv.innerHTML = '<span class="error">Please enter both SMS texts</span>';
        return;
      }

      try {
        const response = await fetch('/api/test-sms-matching', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ senderSMS: sender, receiverSMS: receiver })
        });
        
        const data = await response.json();
        
        if (data.success) {
          let html = `<h3>üìä Matching Analysis</h3>`;
          html += `<p><strong>Match Score:</strong> ${(data.data.matching.senderToReceiverScore * 100).toFixed(1)}%</p>`;
          html += `<p><strong>Should Match:</strong> ${data.data.matching.shouldMatch ? '‚úÖ YES' : '‚ùå NO'}</p>`;
          
          html += `<h4>Sender SMS:</h4>`;
          html += `<ul>`;
          html += `<li>Type: ${data.data.sender.type.type}</li>`;
          html += `<li>Reference: ${data.data.sender.identifiers.refNumber || 'None'}</li>`;
          html += `<li>Amount: ${data.data.sender.identifiers.amount}</li>`;
          html += `</ul>`;
          
          html += `<h4>Receiver SMS:</h4>`;
          html += `<ul>`;
          html += `<li>Type: ${data.data.receiver.type.type}</li>`;
          html += `<li>Reference: ${data.data.receiver.identifiers.refNumber || 'None'}</li>`;
          html += `<li>Amount: ${data.data.receiver.identifiers.amount}</li>`;
          html += `</ul>`;
          
          resultDiv.innerHTML = html;
        } else {
          resultDiv.innerHTML = `<span class="error">${data.error}</span>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<span class="error">Error: ${error.message}</span>`;
      }
    }

    async function runQuickTests() {
      const testCases = [
        {
          name: "CBE Sender SMS",
          sms: `Dear Defar, You have transfered ETB 50.00 to Defar Gobeze on 07/12/2025 at 21:58:15 from your account 1*****6342. Your account has been debited with a S.charge of ETB 0.50 and  15% VAT of ETB0.08, with a total of ETB50.58. Your Current Balance is ETB 285,823.10. Thank you for Banking with CBE! https://apps.cbe.com.et:100/?id=FT253422RPRW11206342 For feedback click the link https://forms.gle/R1s9nkJ6qZVCxRVu9`,
          expectedRef: "FT253422RPRW"
        },
        {
          name: "Simple Sender SMS",
          sms: `You have transfered ETB 100.00 to Admin. Txn ID: FT123456ABCD`,
          expectedRef: "FT123456ABCD"
        }
      ];

      const resultDiv = document.getElementById('quickTests');
      resultDiv.innerHTML = '<p>Running tests...</p>';

      try {
        const response = await fetch('/api/batch-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ testCases })
        });
        
        const data = await response.json();
        
        let html = `<h3>üìã Batch Test Results</h3>`;
        html += `<p><strong>Success Rate:</strong> ${data.summary.successRate}</p>`;
        html += `<p><strong>Passed:</strong> ${data.summary.passed} / <strong>Failed:</strong> ${data.summary.failed}</p>`;
        
        html += `<table border="1" cellpadding="10" style="width: 100%; margin-top: 20px;">`;
        html += `<tr><th>Test</th><th>Reference</th><th>Expected</th><th>Result</th></tr>`;
        
        data.results.forEach(test => {
          html += `<tr>`;
          html += `<td>${test.name}</td>`;
          html += `<td>${test.extracted?.refNumber || 'None'}</td>`;
          html += `<td>${test.expected || 'N/A'}</td>`;
          html += `<td>${test.match || (test.success ? '‚úì' : '‚úó')}</td>`;
          html += `</tr>`;
        });
        
        html += `</table>`;
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `<span class="error">Error: ${error.message}</span>`;
      }
    }
  </script>
</body>
</html>